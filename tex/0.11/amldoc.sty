%!TEX TS-program = xelatex
%!TEX encoding = UTF-8 Unicode

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{amldoc}[2020/06/26 v0.11 Aml style customization]

%\RequirePackage{fourier}
\usepackage[a4paper]{geometry}
%\usepackage{amsmath}
\usepackage{mathspec,xltxtra,xunicode,xspace,titling,ifpdf}
\RequirePackage{color}
\RequirePackage{colortbl}
\usepackage[usenames,dvipsnames]{xcolor}
\usepackage{fontspec}
%\usepackage{unicode-math}
\usepackage{longtable}

\RequirePackage{a4}
\setlength{\textheight}{22.5cm}

% fancy headings
\RequirePackage[clearempty]{titlesec}

\newcommand{\docversion}{unknown}
\renewcommand{\maketitlehookb}{\begin{center} {\large Version \docversion}\end{center}}

\newcommand{\mychaptername}{Chapter}
\titleformat{name=\chapter}
   [display]
   {\sffamily\bfseries\Huge}%
   {\textnormal{\chapterfont\Large\mychaptername{} \thechapter}}%
   {0pt}%
   {\vspace*{2.5mm}}%
   [\vspace*{8mm}]%
\titleformat{name=\chapter,numberless}%
   [display]%
   {\vspace*{-30mm}\sffamily\bfseries\Large}%
   {}%
   {0pt}%
   {}%
   [\vspace*{2mm}]%
\titleformat{name=\section}
   {\sffamily\bfseries\huge}
   {\thesection}
   {1em}
   {}
\titlespacing{\section}{0pt}{*4}{*2}
\titleformat{name=\subsection}
   {\sffamily\bfseries\Large}
   {\thesubsection}
   {0.67em}
   {}
\titlespacing{\subsection}{0pt}{*2}{*1}
\titleformat{name=\subsubsection}
   {\sffamily\bfseries\large}
   {\thesubsubsection}
   {0.55em}
   {}
\titleformat{name=\paragraph}
   [runin]
   {\rmfamily\normalsize\bfseries}
   {}
   {opt}
   {}
   [.\ ]
\titleformat{name=\subparagraph}
   [runin]
   {\itshape}
   {}
   {0pt}
   {}
   [.\ ]
\addtocounter{secnumdepth}{1}
\setcounter{tocdepth}{3}

% fancy footers
\RequirePackage[perpage,multiple,bottom,para]{footmisc}

% fancy headers
\RequirePackage{fancyhdr}
\pagestyle{fancy}
\fancypagestyle{plain}{\fancyhf{}%
   \renewcommand{\headrulewidth}{0pt}%
   \renewcommand{\footrulewidth}{0pt}}

\RequirePackage[hidelinks]{hyperref}

\makeatletter
%%%
\@ifundefined{chaptermark}{}{\renewcommand{\chaptermark}[1]{\markboth{#1}{}}}
%%%
\makeatother
%%%
\renewcommand{\sectionmark}[1]{\markright{\thesection\ \ #1}}
\fancyhf{}
\fancyhead[LE,RO]{\sffamily\footnotesize\thepage}
\fancyhead[RE]{\sffamily\footnotesize\leftmark}
\fancyhead[LO]{\sffamily\footnotesize\rightmark}
\renewcommand{\headrulewidth}{0.5pt}

% set up typefaces
\usepackage{libertine}[oldstyle]
\defaultfontfeatures{Mapping=tex-text,Ligatures=TeX,Numbers=OldStyle}
%\setmainfont{Linux Libertine O}[Scale=0.96]
%\setromanfont{Linux Libertine 0}[Scale=0.96]
%\setsansfont{Alegreya Sans}[Scale=MatchLowercase]
%\setmonofont[Scale=MatchLowercase,Mapping=]{Fira Code}
%\setmonofont{Fira Code}[
\setmonofont{Cascadia Code}[
  %BoldFont=Fira Code Bold,%
  Scale=MatchLowercase,%
  Contextuals=Alternate % Activate the calt feature 
]
\setmathfont(Digits,Latin,Greek)[Scale=MatchUppercase]{Linux Libertine O}
\newfontfamily\headingfont[]{Alegreya}
\newfontfamily\chapterfont[]{Alegreya Sans}
\renewcommand{\maketitlehooka}{\headingfont}
\setlength{\parindent}{0pt}
\setlength{\parskip}{8pt plus 2pt minus 2pt}

% customize font sizes
\makeatletter
\renewcommand\Huge{\@setfontsize\Huge{28pt}{30}}
\renewcommand\huge{\@setfontsize\huge{22pt}{24}}
\renewcommand\Large{\@setfontsize\Large{18pt}{20}}
\makeatother

\usepackage{listings}

\lstdefinelanguage[ExtraComments]{Aml}{
  morecomment=[l]\#!,%
  morecomment=[l]--,%
  morecomment=[n]{\{-}{-\}},%
}[comments]%

\lstdefinelanguage{Aml}{
  alsoletter={-!?},%
  morekeywords={%
    abstract,%
    advice,%
    after,%
    alias,%
    all,%
    also,%
    and,%
    annotation,%
    arguments,%
    around,%
    as,%
    as?,%
    as!,%
    aspect,%
    assert,%
    attribute,%
    begin,%
    before,%
    break,%
    broken,%
    by,%
    case,%
    catch,%
    class,%
    cloned,%
    constant,%
    constraint,%
    constructor,%
    convenience,%
    declare,%
    defer,%
    delta,%
    destructor,%
    digits,%
    dispatch,%
    do,%
    do!,%
    done,%
    down,%
    downcast,%
    else,%
    end,%
    ensure,%
    enum,%
    eval,%
    execution,%
    exhausted,%
    exit,%
    extension,%
    family,%
    failure,%
    final,%
    for,%
    foreign,%
    fun,%
    function,%
    functor,%
    get,%
    given,%
    global,%
    goto,%
    handle,%
    handler,%
    if,%
    implicit,%
    immutable,%
    in,%
    include,%
    infix,% infix non-associative
    infixl,% infix left-associative
    infixr,% infix right-associative
    inherit,%
    instance,%
    interface,%
    invariant,%
    invoke,%
    is,%
    is!,%
    joinpoint,%
    label,%
    lazy,%
    let,%
    let?,%
    let!,%
    local,%
    loop,%
    macro,%
    match,%
    measure,%
    member,%
    memoize,%
    message,%
    method,%
    module,%
    multi,%
    mutable,%
    native,%
    new,%
    next,%
    nil,%
    nonfix,%
    not,%
    not!,%
    object,%
    of,%
    opaque,%
    open,%
    open!,%
    operator,%
    optional,%
    or,%
    otherwise,%
    out,%
    outer,%
    override,%
    parallel,%
    per-self,%
    per-target,%
    pointcut,%
    postfix,%
    pragma,%
    prefer,%
    private,%
    protected,%
    protocol,%
    public,%
    pure,%
    raise,%
    raises,%
    raising,%
    range,%
    rec,%
    recursive,%
    redo,%
    ref,%
    refinement,%
    reflect,%
    release,%
    reraise,%
    reraises,%
    rescue,%
    resignal,%
    resignals,%
    retain,%
    rethrow,%
    rethrows,%
    retry,%
    return,%
    return!,%
    returning,%
    returns,%
    required,%
    scope,%
    sealed,%
    self,%
    set,%
    sequence,%
    sig,%
    signal,%
    signalling,%
    signals,%
    signature,%
    skip,%
    some,%
    step,%
    struct,%
    structure,%
    success,%
    super,%
    switch,%
    synchronized,%
    tailcall,%
    target,%
    then,%
    throw,%
    throwing,%
    throws,%
    to,%
    trait,%
    transparent,%
    try,%
    try?,%
    try!,%
    type,%
    undefined,%
    unless,%
    unowned,%
    until,%
    up,%
    upcast,%
    use,%
    use!,%
    val,%
    val?,%
    var,%
    var?,%
    variant,%
    weak,%
    when,%
    where,%
    while,%
    with,%
    without,%
    xor,%
    yield,%
    yield!,%
    yielding},%
  sensitive,%
  morecomment=[l]--,%
  morecomment=[n]{\{-}{-\}},%
}[keywords,comments]


\lstdefinestyle{FiraCodeStyle}{
  basewidth=0.58em,
  literate=
    {www}{{www}}3
    {**}{{**}}2
    {***}{{***}}3
%    {**/}{{**/}}3 % Removed in Fira Code v1.206
    {*>}{{*>}}2
%    {*/}{{*/}}2 % Interferes with comment highlighting
%    {\\\\}{{\textbackslash\textbackslash}}2 % Removed in Fira Code v1.206
%    {\\\\\\}{{\textbackslash\textbackslash\textbackslash}}3 % Removed in Fira Code v1.206
%    {\{-}{{\{-}}2 % Removed in Fira Code v1.206
%    {[]}{{[]}}2 % Removed in Fira Code v1.206
    {::}{{::}}2
    {:::}{{:::}}3
    {:=}{{:=}}2
    {!!}{{!!}}2
%    {!!!}{{!!!}}3 % Removed in Fira Code v1.206
    {!=}{{!=}}2
    {!==}{{!==}}3
%    {-\}}{{-\}}}2 % Removed in Fira Code v1.206
    {--}{{--}}2
    {---}{{---}}3
    {-->}{{-->}}3
    {->}{{->}}2
    {->>}{{->>}}3
    {-<}{{-<}}2
    {-<<}{{-<<}}3
    {-~}{{-\textasciitilde}}2
    {\#\{}{{\#\{}}2
    {\#[}{{\#[}}2
    {\#\#}{{\#\#}}2
    {\#\#\#}{{\#\#\#}}3
    {\#\#\#\#}{{\#\#\#\#}}4
    {\#(}{{\#(}}2
    {\#?}{{\#?}}2
    {\#_}{{\#\_}}2
    {\#_(}{{\#\_(}}3
    {.-}{{.-}}2
    {.=}{{.=}}2
    {..}{{..}}2
    {..<}{{..<}}3
    {...}{{...}}3
    {?=}{{?=}}2
    {??}{{??}}2
%    {???}{{???}}3 % Removed in Fira Code v1.206
%    {;;}{{;;}}2 % Interferes with comment highlighting
%    {;;;}{{;;;}}3 % Removed in Fira Code v1.206
%    {/*}{{/*}}2 % Interferes with comment highlighting
%    {/**}{{/**}}3 % Removed in Fira Code v1.206
    {/=}{{/=}}2
    {/==}{{/==}}3
    {/>}{{/>}}2
%    {//}{{//}}2 % Interferes with comment highlighting
%    {///}{{///}}3 % Interferes with comment highlighting
    {\&\&}{{\&\&}}2
%    {\&\&\&}{{\&\&\&}}3 % Removed in Fira Code v1.206
    {||}{{||}}2
%    {|||}{{|||}}3 % Removed in Fira Code v1.206
    {||=}{{||=}}3
    {|=}{{|=}}2
    {|>}{{|>}}2
    {^=}{{\textasciicircum=}}2
    {$>}{{\$>}}2
    {++}{{++}}2
    {+>}{{+>}}2
    {=:=}{{=:=}}3
    {==}{{==}}2
    {===}{{===}}3
    {==>}{{==>}}3
    {=>}{{=>}}2
    {=>>}{{=>>}}3
%    {=<}{{=<}}2 % Removed in Fira Code v1.206
    {=<<}{{=<<}}3
%    {=~}{{=\textasciitilde}}2 % Removed in Fira Code v1.206
    {=/=}{{=/=}}3
    {>-}{{>-}}2
    {>=}{{>=}}2
    {>=>}{{>=>}}3
    {>>}{{>>}}2
    {>>-}{{>>-}}3
    {>>=}{{>>=}}3
    {>>>}{{>>>}}3
    {<*}{{<*}}2
    {<*>}{{<*>}}3
    {<|}{{<|}}2
    {<|>}{{<|>}}3
    {<$}{{<\$}}2
    {<$>}{{<\$>}}3
    {<!--}{{<!--}}4
    {<-}{{<-}}2
    {<--}{{<--}}3
    {<->}{{<->}}3
    {<+}{{<+}}2
    {<+>}{{<+>}}3
    {<=}{{<=}}2
    {<==}{{<==}}3
    {<=>}{{<=>}}3
    {<=<}{{<=<}}3
    {<>}{{<>}}2
    {<<}{{<<}}2
    {<<-}{{<<-}}3
    {<<=}{{<<=}}3
    {<<<}{{<<<}}3
    {<~}{{<\textasciitilde}}2
    {<~~}{{<\textasciitilde\textasciitilde}}3
    {</}{{</}}2
    {~@}{{\textasciitilde @}}2
    {~-}{{\textasciitilde-}}2
    {~=}{{\textasciitilde=}}2
    {~>}{{\textasciitilde>}}2
    {~~}{{\textasciitilde\textasciitilde}}2
    {~~>}{{\textasciitilde\textasciitilde>}}3
%    {~~~}{{\textasciitilde\textasciitilde\textasciitilde}}3 % Removed in Fira Code v1.206
    {\%\%}{{\%\%}}2
%    {\%\%\%}{{\%\%\%}}3 % Removed in Fira Code v1.206
    {<==>}{{<==>}}4
    {<||}{{<||}}3
    {<|||}{{<|||}}4
    {|||>}{{|||>}}4
    {</>}{{</>}}3
    {<~>}{{<\textasciitilde>}}3
    {<-<}{{<-<}}3
    {>->}{{>->}}3
    {=!=}{{=!=}}3
    {+++}{{+++}}3
    {||>}{{||>}}3
    {_|_}{{\_|\_}}3
    {..=}{{..=}}3
    {!!.}{{!!.}}3
    {::=}{{::=}}3
    {<:}{{<:}}2
    {>:}{{>:}}2
    {|-}{{|-}}2
    {|]}{{|]}}2
    {|\}}{{|\}}}2
    {__}{{\_\_}}2
    {?.}{{?.}}2
    {?:}{{?:}}2
    {.?}{{.?}}2
    {\#=}{{\#=}}2
    {\#!}{{\#!}}2
    {\#:}{{\#:}}2
    {-|}{{-|}}2
    {:<}{{:<}}2
    {:>}{{:>}}2
    {]\#}{{]\#}}2
    {[|}{{[|}}2
    {\{|}{{\{|}}2
}

% activate the language and predefine settings
\lstset{
    language=Aml,%
    style=FiraCodeStyle,%
    xleftmargin=4mm,%
    aboveskip=4mm,%
    belowskip=4mm,%
    fontadjust=true,%
    columns=[c]fixed,%
    keepspaces=true,%
    basewidth=0.6em,%
    tabsize=2,%
    basicstyle=\renewcommand{\baselinestretch}{0.95}\ttfamily,%
    commentstyle=\itshape\color{gray},%
    keywordstyle=\bfseries,%
    mathescape=true,%
    captionpos=b,%
    framerule=0.3pt,%
    firstnumber=0,%
    numbersep=1.5mm,%
    numberstyle=\tiny,%
    escapeinside={(*@}{@*)},%
    inputencoding=utf8,%
}

\newcommand{\code}[1]{%
    \lstinline[%keywordstyle=,%
               flexiblecolumns=true,%
               basicstyle=\ttfamily]£#1£}

\usepackage{multicol}
\usepackage{multirow}
\usepackage{array}
\usepackage{booktabs}
\usepackage[justification=justified,singlelinecheck=false]{caption}
\usepackage{minitoc}
\setcounter{minitocdepth}{3}

\newcommand{\clearemptydoublepage}{\newpage{\pagestyle{empty}\cleardoublepage}}

\newcommand{\syntax}{{\bf Syntax:}}
\newcommand{\grammar}{{\bf Grammar:}}
\newcommand{\sref}[1]{\S\ref{#1}}
\newcommand{\comma}{,\,}
\newcommand{\commadots}{\comma \ldots \comma}
\newcommand{\gap}{\quad\quad}
\newcommand{\txtsub}[1]{\textsubscript{#1}}
\newcommand{\txtsup}[1]{\textsuperscript{#1}}

\newcounter{Example}[section]
\newcounter{result}[section]

\def\example{
   \def\theresult{Example~\thesection.\arabic{result}}
   \refstepcounter{result}
   \trivlist\item[\hskip
   \labelsep{\bf \theresult}]}
\def\endexample{\endtrivlist}

\def\definition{
   \def\theresult{Definition~\thesection.\arabic{result}}
   \refstepcounter{result}
   \trivlist\item[\hskip
   \labelsep{\bf \theresult}]}
\def\enddefinition{\endtrivlist}

\newcommand{\ba}{\begin{array}}
\newcommand{\ea}{\end{array}}
\newcommand{\bda}{\[\ba}
\newcommand{\eda}{\ea\]}
\newcommand{\Dollar}{\mbox{\$}}

\newcommand{\Aml}{\lstinline!Aml!\xspace}
\newcommand{\AmlKernel}{\lstinline!Aml/Kernel!\xspace}
\newcommand{\AmlBase}{\lstinline!Aml/Base!\xspace}
\newcommand{\AmlBootstrap}{\lstinline!Aml/Bootstrap!\xspace}
\newcommand{\AmlCore}{\lstinline!Aml/Core!\xspace}
\newcommand{\ToolAml}{\lstinline!aml!\xspace}
\newcommand{\ToolAmlc}{\lstinline!amlc!\xspace}
\newcommand{\ToolAmlrun}{\lstinline!amlrun!\xspace}
\newcommand{\ToolAmldebug}{\lstinline!amldebug!\xspace}
\newcommand{\ToolAmlprof}{\lstinline!amlprof!\xspace}
\newcommand{\ToolAmlbuild}{\lstinline!amlbuild!\xspace}
\newcommand{\ToolAmlbook}{\lstinline!amlbook!\xspace}

% maybe?
\newcommand{\AmlSystem}{\lstinline!Aml/System!\xspace}

\newcommand{\SharpSign}{\textsuperscript{\symbol{"266F}}\xspace}



